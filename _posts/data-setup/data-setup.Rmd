---
draft: false
title: "Data Set-Up"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
description: |
  The transformations being applied to the data before analysis
author:
  - name: "Brian Muchmore"
    url: https://github.com/bmuchmore
    affiliation: GENYO
    affiliation_url: http://www.genyo.es/
output:
  radix::radix_article:
    self_contained: false
---

## Package Information    

These are the packages I will be using.

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
library(PreciseDist)
library(tidyverse)
library(missRanger)
```

This is the session info.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
sessionInfo()
```

```{r preview = TRUE, layout="l-body-outset", eval = TRUE, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
library(png)
library(RCurl)
library(ggplot2)
my_image <- readPNG(getURLContent("https://raw.githubusercontent.com/bmuchmore/PreciseDist_Paper/master/images/session_info.png"))
ggplot(data.frame()) + annotation_raster(my_image, -Inf, Inf, -Inf, Inf)
```


```{r eval = FALSE, include = FALSE}
## Tried to get the following to work to automatically capture the output of session info, but alas, could  not.
## Leaving here for self-posterity
library(carbonate)
library(RSelenium)
x <- carbon$new()
x <- carbon$new(sessionInfo())
x$download_path <- file.path("/home/Downloads/test")
x$carbonate(file = "session_info.png")
x$stop_all()
```

## General Data Manipulations    

First we load the clinical data. All of the data I use was taken directly from [tranSMART](https://transmart.quartzbio.com/transmart/login/auth).    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
data <- read_tsv("/home/brian/Desktop/flow/data_clinical.tsv")
```

The column names of the data are in a terrible format for R analysis, so we make them more amenable.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
colnames(data) <- tolower(colnames(data))
colnames(data) <- gsub("[[:space:]]", "_", colnames(data))
colnames(data) <- gsub("\\", "_", colnames(data), fixed = TRUE)
colnames(data) <- gsub("_$", "", colnames(data))
colnames(data) <- gsub("^_", "", colnames(data))
colnames(data) <- gsub("cross_sectional_low_dimensional_data_", "", colnames(data))
colnames(data) <- gsub("\\(", "", colnames(data))
colnames(data) <- gsub("\\)", "", colnames(data))
colnames(data) <- gsub("\\'", "", colnames(data))
colnames(data) <- gsub(">=", "greater_equal", colnames(data))
colnames(data) <- gsub("<=", "lesser_equal", colnames(data))
colnames(data) <- gsub("=", "equal", colnames(data))
colnames(data) <- gsub("==", "equal", colnames(data))
colnames(data) <- gsub("[[:punct:]]", "_", colnames(data))
colnames(data) <- gsub("^\\s+|\\s+$", "", colnames(data))
```

## Clinical Data Manipulations    

At this point, we will get rid of various columns in the data to leave us with the pertinent clinical, HLA, luminex, metabolomic, sub-study and auto-antibody data. We will use this data downstream as descriptor data to label (e.g. color code) our clusters, and also as the input data into supervised learning algorithms to see if we can predict our clusters. This will become more clear later.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_filter_data <- data %>%
  select(-contains("flow_cyto")) %>%
  select(
    -clinical_consent_informed_consent_date_1,
    -clinical_consent_cs_phase,
    -clinical_diagnosis_arm_code,
    -clinical_sampling_patient_id,
    -clinical_sampling_omic_number,
    -subject_id,
    -metabolomics_plasmanmr_wilmut_id,
    -metabolomics_plasmanmr_x1_31903
  )
```

We just filtered our clinical data for columns that don't make sense to include downstream. For example, when we try to predict our unsupervised clusters later with the clinical data to look for associations, it makes no sense to include something like the patient ID, which is guaranteed to be unique for every patient. Now we will filter columns according to the percentage of missing data. In this case, we keep all columns with 10% or less missing data. Note that this code will mostly toss sub-study columns that of course have more than 10% of their data missing.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_filtered_data <- clinical_filter_data[, colMeans(is.na(clinical_filter_data)) <= 0.89]
```
  
At this point, it would be nice to get a sense for which columns are left and what data-types exist in the data.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_filtered_colnames <- colnames(clinical_filtered_data) %>%
  as_tibble() %>%
  select(clinical_colnames = value)
clinical_filtered_coltypes <- map(clinical_filtered_data, typeof) %>%
  unique() %>%
  unlist()
```

We have character and numeric columns, but we need the character columns to be of type factor for some downstream algorithms, so first we split out all of the character columns and then we mutate all character columns into factor columns.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_factor_data <- select_if(clinical_filtered_data, is.character) %>%
  mutate_if(is.character, as.factor)
```

Even though we filtered columns with more than 10% missing data, we still have some missing data, so we will impute all of the now-factor columns.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_factor_imputed_data <- clinical_factor_data %>%
  missRanger(
    maxiter = 10L,
    pmm.k = 5,
    seed = NULL,
    num.trees = 500,
    mtry = NULL,
    num.threads = 16
  )

write_rds(clinical_factor_imputed_data, "/home/brian/Desktop/flow/clinical_factor_imputed_data.rds")
```

We don't need to change numeric columns to a different type, but we do need to impute them, so we split out all of the numeric columns and impute.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_numeric_data <- select_if(clinical_filtered_data, is.numeric)
clinical_numeric_imputed_data <- clinical_numeric_data %>%
  missRanger(
    maxiter = 10L,
    pmm.k = 5,
    seed = NULL,
    num.trees = 500,
    mtry = NULL,
    num.threads = 16
  )

write_rds(clinical_numeric_imputed_data, "/home/brian/Desktop/flow/clinical_numeric_imputed_data.rds")
```

Now that we have the clinical data in the correct format without any missing data, we recombine the data and make sure that all the NAs are gone.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_imputed_data <- cbind(clinical_factor_imputed_data, clinical_numeric_imputed_data)
anyNA(clinical_imputed_data)
```

The final step is to remove columns with either zero or little variance within them because they are unlikely to provide us with much useful information.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
vars <- colnames(clinical_imputed_data)
roles <- rep("predictor", length(vars))
clinical_transformed_data <- clinical_imputed_data %>%
  recipe(vars = vars, roles = roles) %>%
  step_zv(all_predictors()) %>%
  step_nzv(all_predictors()) %>%
  prep() %>%
  bake(newdata = clinical_imputed_data)
```

Now we seperate the data into case-only and control-only data. The **clinical_transformed_data** already contains both case and control data, but we also assign it to a new R object to keep the naming conventions similar.  

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
clinical_case_data <- clinical_transformed_data %>%
  filter(clinical_diagnosis_arm == "Case")
clinical_control_data <- clinical_transformed_data %>%
  filter(clinical_diagnosis_arm == "Control")
clinical_case_control_data <- clinical_transformed_data
```

## Flow Cytometry Data Manipulations    

Now we will manipulate the flow cytometry data to put it into a more ammenable form for data analysis. First, we split out the flow cytometry data as a whole, and then all the columns that refer to panel 1 and panel 2, which are the only panels that were run for every patient in the study.   

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
flow_data <- data %>%
  select(clinical_diagnosis_arm, contains("flow_cyto")) %>%
  select(clinical_diagnosis_arm, contains("p1"), contains("p2"))
colnames(flow_data) <- gsub("flow_cytometry_p1_", "", colnames(flow_data))
colnames(flow_data) <- gsub("flow_cytometry_p2_", "", colnames(flow_data))
```

The data has very few missing values in it, but there are a few, so we impute those.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
flow_imputed_data <- flow_data %>%
  select(-clinical_diagnosis_arm) %>%
  missRanger(
    maxiter = 10L,
    pmm.k = 5,
    seed = NULL,
    num.trees = 1501,
    mtry = NULL,
    num.threads = 16
  )
write_rds(flow_imputed_data, "/home/brian/Desktop/flow/flow_imputed_data.rds")
```

Now we will transform the data. The transformations done here, for example, removing zero-variance columns and applying a Yeo-Johnson normalizing transformation are done partly on a trial-and-error basis.    

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
vars <- colnames(flow_imputed_data)
roles <- rep("predictor", length(vars))
flow_transformed_data <- flow_imputed_data %>%
  recipe(vars = vars, roles = roles) %>%
  step_zv(all_predictors()) %>%
  step_YeoJohnson(all_predictors()) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors()) %>%
  prep() %>%
  bake(newdata = flow_imputed_data) %>%
  cbind(select(flow_data, clinical_diagnosis_arm)) %>%
  select(clinical_diagnosis_arm, everything())
```

Lastly, we will seperate the data into case-only and control-only data. The **flow_transformed_data** already contains both case and control data, but we also assign it to a new R object to keep the naming conventions similar.  

```{r preview = FALSE, eval = FALSE, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, comment = NA, R.options = list(width = 70)}
flow_case_data <- flow_transformed_data %>%
  filter(clinical_diagnosis_arm == "Case") %>%
  select(-clinical_diagnosis_arm)
flow_control_data <- flow_transformed_data %>%
  filter(clinical_diagnosis_arm == "Control") %>%
  select(-clinical_diagnosis_arm)
flow_case_control_data <- flow_transformed_data %>%
  select(-clinical_diagnosis_arm)
```



